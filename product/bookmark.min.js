// Bookmark.js
// www.bespoyasov.ru

(function(a){a.fn.bookmark=function(w){var b=a.extend({autoHide:!0,fadeTime:400,autoHideTime:800,scrollingTime:500,heightDelta:100,hashChange:!0,hashPrefix:"",bookmarkClassName:"bookmark",touchDevices:!1,onScrollStart:function(){},onScrollEnd:function(){}},w);return this.each(function(){function w(a){a=a.toLowerCase();var b={"\u0430":"a","\u0431":"b","\u0432":"v","\u0433":"g","\u0434":"d","\u0435":"e","\u0451":"e","\u0436":"zh","\u0437":"z","\u0438":"i","\u0439":"j","\u043a":"k","\u043b":"l","\u043c":"m",
"\u043d":"n","\u043e":"o","\u043f":"p","\u0440":"r","\u0441":"s","\u0442":"t","\u0443":"u","\u0444":"f","\u0445":"h","\u0446":"c","\u0447":"ch","\u0448":"sh","\u0449":"sh","\u044a":"-","\u044b":"y","\u044c":"-","\u044d":"e","\u044e":"yu","\u044f":"ya"," ":"-",_:"-","`":"-","~":"-","!":"-","@":"-","#":"-",$:"-","%":"-","^":"-","&":"-","*":"-","(":"-",")":"-","-":"-","=":"-","+":"-","[":"-","]":"-","\\":"-","|":"-","/":"-",".":"-",",":"-","{":"-","}":"-","'":"-",'"':"-",";":"-",":":"-","?":"-","<":"-",
">":"-","\u2116":"-"},d="",e="";for(i=0;i<a.length;i++)if(void 0!=b[a[i]]){if(e!=b[a[i]]||"-"!=e)d+=b[a[i]],e=b[a[i]]}else d+=a[i],e=a[i];a=d.replace(/^-/,"");return d=a.replace(/-$/,"")}function A(){return 0<=navigator.userAgent.search("Safari")&&0>navigator.userAgent.search("Chrome")}function B(b,c){var d=0;b.find("."+m).each(function(){t[d]=a(this).offset().top;var e=a(this).parents('[data-session="'+c+'"]').find("."+m+'[data-index="'+(d+1)+'"]').offset();C[d]=void 0!=e?e.top:1E7;++d})}function K(c,
r){var d=location.hash.toString().replace("#","");if(""!==d){var e=b.hashPrefix,g=a("[data-session]").find("."+m+'[data-name="'+e+d+'"]').attr("data-index");b.onScrollStart(0,parseInt(g));a(".bookmarks-container-"+r).find("[data-index]").removeClass("active");a(".bookmarks-container-"+r).find('[data-index="'+g+'"]').addClass("active");a("html, body").delay(b.scrollingTime).animate({scrollTop:a("[data-session]").find("."+m+'[data-name="'+e+d+'"]').offset().top},b.scrollingTime);setTimeout(function(){b.onScrollEnd(0,
parseInt(g))},b.scrollingTime)}}function L(b,c){var d=0;b.find("."+m).each(function(){var e=a(this),g=b.height(),e=e.offset().top/g,e=(a("html").height()*e).toFixed(0);if(void 0!=a(".bookmarks-container-"+c+' [data-index="'+(d-1)+'"]').offset()){var f=a(".bookmarks-container-"+c+' [data-index="'+(d-1)+'"]'),g=f.outerHeight(),f=f.offset().top,f=g+f,e=parseInt(e);e<f&&(e+=g)}a(".bookmarks-container-"+c+' [data-index="'+d+'"]').css({top:e+"px"});++d})}function D(b){a("html").find(".bookmarks-container-"+
b).addClass("hover")}function M(b){if(x){var c=Math.abs(u-E)/F,d=parseFloat(a("html").find(".bookmarks-container-"+b).css("opacity")),e=Math.max(c,d);c<d&&(y=!1,c=Math.abs(v[v.length-2]-u)/(10*F),e+=c);a("html").find(".bookmarks-container-"+b).css({opacity:e})}else a("html").find(".bookmarks-container-"+b).addClass("nmhover")}function G(c){b.autoHide&&(x?a("html").find(".bookmarks-container-"+c).removeClass("hover").animate({opacity:"0"},b.fadeTime):a("html").find(".bookmarks-container-"+c).removeClass("hover nmhover").animate({opacity:"0"},
b.fadeTime))}function H(b){a("html").find(".bookmarks-container-"+b).stop()}function N(b){a("html").find(".bookmarks-container-"+b).css({opacity:"1"})}function O(f,r){n=!0;var d=f.attr("data-index"),e=a("html").find(".bookmarks-span.active").attr("data-index");b.onScrollStart(parseInt(e),parseInt(d));setTimeout(function(){n=!1;b.onScrollEnd(parseInt(e),parseInt(d))},b.scrollingTime);f.parents(".bookmarks-container-"+c).find(".bookmarks-span").removeClass("active");f.addClass("active");a("html, body").animate({scrollTop:a("[data-session]").find("."+
m+'[data-index="'+d+'"]').offset().top},b.scrollingTime);if(b.hashChange){var g=decodeURI(p[d]);A()&&(g=p[d]);location.hash=b.hashPrefix+g}}function P(f,r){if(n)return!1;f.find("."+m);for(var d=0,e=a(window).scrollTop(),g=0;g<t.length;++g)e>=t[g]&&e<C[g]&&(d=g);e>=a(document).height()-a(window).height()&&(d=t.length-1);0==e&&(d=0);a(".bookmarks-container-"+c).find("a[data-index]").removeClass("active");a(".bookmarks-container-"+c).find('a[data-index="'+d+'"]').addClass("active");b.hashChange&&(e=
decodeURI(p[d]),A()&&(e=p[d]),location.hash=b.hashPrefix+e)}var I=!1;-1!=navigator.userAgent.toLowerCase().indexOf("windows phone")&&(I=!0);var Q="ontouchstart"in document.documentElement,R=-1<navigator.userAgent.toLowerCase().indexOf("android"),x=0<=navigator.platform.toUpperCase().indexOf("MAC"),c=Math.floor(100*Math.random())+1+(Math.floor(100*Math.random())+1),t=[],C=[],p=[],J=!1,n=!1,q=!1,z=!1,E=0,u=0,y=!0,v=[],F=10*b.heightDelta,m=b.bookmarkClassName,f=a(this);a(this).attr("data-session",c);
c=a(this).attr("data-session");"false"==f.attr("data-autoHide")&&(b.autoHide=!1);void 0!=f.attr("data-fadeTime")&&(b.fadeTime=parseInt(f.attr("data-fadeTime")));void 0!=f.attr("data-autoHideTime")&&(b.autoHideTime=parseInt(f.attr("data-autoHideTime")));void 0!=f.attr("data-scrollingTime")&&(b.scrollingTime=parseInt(f.attr("data-scrollingTime")));void 0!=f.attr("data-heightDelta")&&(b.heightDelta=parseInt(f.attr("data-heightDelta")));"false"==f.attr("data-hashChange")&&(b.hashChange=!1);void 0!=f.attr("data-hashPrefix")&&
(b.hashPrefix=f.attr("data-hashPrefix"));"true"==f.attr("data-touchDevices")&&(b.touchDevices=!0);void 0!=f.attr("data-bookmarkClassName")&&(b.bookmarkClassName=f.attr("data-bookmarkClassName"),m=b.bookmarkClassName);x||a("html").addClass("bookmark-notMac");if(Q||I||R)if(b.touchDevices)a("html").addClass("bookmark-touches");else return!1;a("html").append('<div class="bookmarks-hoverzone bookmarks-hoverzone-'+c+'"></div><div class="bookmarks-container bookmarks-container-'+c+'"></div>');(function(b,
f){var d=b.find("."+m),e=0;if(!d.length)return J=!0,!1;d.each(function(){var d=a(this),k=b.height(),k=d.offset().top/k,k=(a("html").height()*k).toFixed(0);d.attr("data-index",e);if(void 0!=a(".bookmarks-container-"+f+' [data-index="'+(e-1)+'"]').offset()){var l=a(".bookmarks-container-"+f+' [data-index="'+(e-1)+'"]'),h=l.outerHeight(),l=l.offset().top,l=h+l,k=parseInt(k);k<l&&(k+=h)}h=d.attr("name")||d.attr("title")||d.attr("alt");void 0==h&&(h="",h=d.text().toString().replace(/(\n(\r)?)/g,"").replace(/\t/g,
"").split(" "),h=h.filter(function(a){return a}),h=h[0]);l="";l=void 0!=d.attr("data-hash")?d.attr("data-hash").toString().replace(/ /g,"-"):w(h);a(".bookmarks-container-"+c).append('<span class="bookmarks-span" data-index="'+e+'" style="top:'+k+'px"><a href="#">'+h+"</a></span>");p[e]=l;d.attr("data-name",l).attr("name","");++e})})(a(this),c);(function(b){var c=0;a(".bookmarks-container-"+b).find("a").each(function(){a(this).width()>c&&(c=a(this).width())});c+=10;a(".bookmarks-container-"+b).width(c);
a(".bookmarks-hoverzone-"+b).width(c)})(c);B(a(this),c);if(J)return console.log("Bookmark.js: You have no bookmarks :\u2013)"),!1;a(".bookmarks-container-"+c).find('.bookmarks-span[data-index="0"]').addClass("active");a(".bookmarks-hoverzone-"+c).on("mouseenter",function(){q=!0;clearTimeout(a.data(this,"scrollTimer"));D(c)});a(".bookmarks-container-"+c).on("mouseenter",function(){q=!0;clearTimeout(a.data(this,"scrollTimer"));D(c)});a(".bookmarks-container-"+c).on("mouseleave",function(){N(c);q=!1;
setTimeout(function(){q||n||(H(c),G(c))},b.autoHideTime)});a(".bookmarks-container-"+c+" a").on("click",function(b){b.preventDefault();O(a(this).parents("[data-index]"),c)});f=a(this);a(document).ready(function(){K(a(this),c)});a(window).scroll(function(){H(c);z||(E=a(this).scrollTop());z=!0;u=a(this).scrollTop();y&&v.push(u);M(c);P(f,c);clearTimeout(a.data(this,"scrollTimer"));a.data(this,"scrollTimer",setTimeout(function(){q||n||(G(c),z=!1,v=[],y=!0)},b.autoHideTime))});a(window).resize(function(){L(f,
c);B(f,c)})})};a(function(){a(".bookmarks").bookmark()})})(jQuery);